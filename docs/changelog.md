# 更新记录

## v2.7.7.5.6 (2025-10-25)
- **优化 AI 字幕下载体验**
- AI 字幕与常规字幕分组下载，缺少登录 Cookie 时提前输出提醒
- 请求字幕时补齐 Referer 并归一化地址，失败时记录响应摘要，解决 403 / 空文件问题
- 自动去除 `ai-` 语言前缀，播放器可正确识别语言；FAQ 新增凭据说明

- **强化 412 风控与稿件缺失判定**
- 重新实现 412 响应分类，区分风控凭证、WAF 限流与稿件缺失，并输出详细上下文
- PlayURL 失败会回查稿件详情并捕获 -404/404 状态，缺失稿件立即停止重试并按 "资源不存在" 分类
- 日志新增 view_info 类型提示，帮助排查接口异常

- **番剧与任务稳定性改进**
- 番剧源校验在收到非番剧枚举时返回错误，避免 panic
- 视频时长未知时跳过弹幕交互随机数，修复 "cannot sample empty range" 崩溃
- 错误分类器同步 412/404 结果，任务状态与重试策略更准确

- **Web 端体验优化**
- 添加视频源时记住上次填写的保存路径，单次与批量添加均可一键复用

## v2.7.7.5.5 (2025-10-09)
- **优化日志输出**
- 将技术细节日志（API请求/响应、认证流程、下载配置等）改为debug级别
- 减少正常运行时的日志输出，提升可读性
- 保留用户关心的重要提示信息（下载状态、风控验证、充电视频检测等）
- 优化番剧季度编号提取逻辑，确保从番剧系列标题中提取季度信息

## v2.7.7.5.4 (2025-10-08)
- **优化默认配置设置**
- 合集使用Season文件夹结构默认启用
- 番剧使用统一Season文件夹结构默认启用
- CDN排序功能默认启用
- 风控验证功能默认启用，模式为手动验证（manual）
- 提升新用户初次使用体验
- **优化视频下载逻辑**
- 支持重新下载覆盖已存在的文件
- 优化元数据和封面下载管理

## v2.7.7.5.3 (2025-10-08)
- **新增空目录自动清理功能**
- 删除视频文件夹后自动清理空的父目录
- 提升文件管理整洁性
- **优化番剧系列名称处理**
- 新增番剧系列名称标准化功能
- 优化系列名称提取逻辑，确保归并判断准确
- 移除系列名称标准化配置项（功能默认启用）
- **优化番剧Season文件夹管理**
- 优化Season文件夹结构使用逻辑
- 正确处理番剧名称提取和排序标题生成
- 调整季度编号提取方式，确保Season文件夹使用正确的季度编号
- 优化season.nfo生成策略
- 新增测试用例以验证系列名称提取准确性

## v2.7.7.5.2.1 (2025-09-30)
- **优化番剧视频下载逻辑**
- 新增基于season_id判断的下载策略
- 调整fanart选择逻辑，优化封面优先级
- **优化视频下载配置**
- 新增视频下载相关配置项，优化默认值设置

## v2.7.7.5.2.0 (2025-09-29)
- **新增硬件指纹系统**
- 新增硬件指纹模块，提升请求安全性
- 支持硬件指纹持久化管理（会话期间固定）
- 动态生成GPU、WebGL、分辨率等硬件信息
- 新增高端GPU型号支持
- **优化HTTP请求头管理**
- 新增标准请求头生成函数，确保请求一致性
- 在视频请求中应用弹幕防挡参数
- 在Aria2下载器中应用新请求头
- **优化视频存在性检查**
- 新增视频存在性检查功能
- 优化HTTP 412风控错误处理逻辑
- 确保视频已删除时返回404错误
- **优化错误处理机制**
- 新增HTTP 404错误忽略处理
- 新增HTTP 412风控错误检测与处理
- 简化错误分类逻辑，移除充电视频特殊处理
- 提升代码可读性和错误分类准确性

## v2.7.7.5.2 (2025-09-28)
- **新增视频源批量添加**
- 新增视频源批量添加
- **新增批量删除功能**
- 支持批量选择并删除视频源
- 优化批量操作用户体验

## v2.7.7.5.1 (2025-09-26)
- **优化视频源添加页面**
- 新增已有视频源过滤功能，防止重复添加
- 已添加的视频源显示"已添加"标签并禁用选择
- 支持合集、收藏、UP主投稿、番剧的重复检测
- 优化页面性能，提升用户体验

## v2.7.7.5 (2025-09-25)
- **前端视频源页面增强**
- 视频源页面现在显示番剧的selected_seasons字段
- 区分显示"主季度ID"和"已选季度ID"
- 优化季度信息的展示格式，提升信息清晰度
- **优化番剧源合并功能**
- 合并时自动使用目标源的名称和路径
- 改进合并逻辑，提升用户体验

## v2.7.7.4.6 (2025-09-25)
- **新增番剧手动合并功能**
- 添加番剧时支持将新番剧合并到已有番剧源
- 适合管理相同系列的多个季度（新季、剧场版等）
- **优化番剧API请求效率**
- 智能利用相关季度信息减少API请求次数

## v2.7.7.4.5 (2025-09-23)
- **优化验证码自动解决服务配置**
- 移除不支持的验证码服务：云码（YunMa）和CapSolver
- 云码平台不支持极验（GeeTest）验证码识别，会导致"缺少参数image"错误
- 简化配置选项，只保留经过验证可用的服务：2Captcha 和 AntiCaptcha
- 更新前后端验证逻辑，避免用户选择不支持的服务
- **修复风控验证页面JSON解析错误**
- 修复验证码提交API路由配置错误（GET改为POST）
- 修复前端提交验证结果时的JSON格式问题
- 优化验证码页面与后端的通信协议

## v2.7.7.4.4 (2025-09-23)
- **修复暂停/恢复扫描后aria2不自动启动的问题**
- 修复暂停扫描任务后恢复时aria2进程无法自动启动的问题
- 优化下载器生命周期管理，确保恢复时创建新的下载器实例

## v2.7.7.4.3 (2025-09-22)
- **修复合集视频NFO文件集数显示错误**
- 修复合集视频NFO文件中集数始终显示为1的问题
- 现在正确显示实际集数（1, 2, 3, ...）

## v2.7.7.4.2 (2025-09-22)
- **修复番剧fanart重复下载问题**
- 修复番剧多集并发下载时同一fanart文件被重复下载导致aria2冲突的问题
- 优化番剧共享资源（Series和Season级别图片）下载逻辑
- 通过让第一个集负责下载共享图片，其他集跳过，彻底避免并发冲突
- 消除了"File exists, but a control file(*.aria2) does not exist"错误
- 提升番剧下载效率，减少无效的重复下载尝试
- **统一封面文件命名规则**
- 调整封面文件命名规则，统一使用`-thumb.jpg`后缀替代之前的`-poster.jpg`
- 优化获取合集封面逻辑，支持分页获取，避免遗漏合集信息
- 提升代码可读性和命名一致性

## v2.7.7.4.1 (2025-09-14)
- **修复番剧通知显示问题**
- 修复番剧下载后通知显示错误集数信息的问题
- 优化通知系统的番剧集数匹配逻辑，使用ep_id进行精确匹配
- 确保每集番剧都能在通知中正确显示对应的标题和集数信息

## v2.7.7.4 (2025-09-14)
- **修复番剧重复BV号导致的下载问题**
- 修复攻壳机动队等番剧因所有集数共享同一BV号导致只能下载一集的问题
- 优化数据库唯一索引，将ep_id字段加入唯一约束以支持番剧多集下载
- 新增数据库迁移机制自动更新索引结构
- 修复番剧识别逻辑，正确使用ep_id进行唯一性检查而不仅依赖BV号
- **修复前端"访问B站"功能**
- 修复视频详情页面"访问B站"按钮对番剧跳转错误的问题
- 普通视频：跳转到 https://www.bilibili.com/video/{bvid}
- 番剧视频：跳转到 https://www.bilibili.com/bangumi/play/ep{ep_id}
- 确保每集番剧都能正确跳转到对应的B站页面

## v2.7.7.3 (2025-09-13)
- 修复登录凭证
- 修复前端配置不生效

## v2.7.7.2 (2025-09-13)
- **修复仪表盘视频统计显示错误**
- 修复"近七日新增视频"统计数量不准确的问题

## v2.7.7.1 (2025-09-12)
- **新增服务器端口配置功能**
- 支持在系统设置中配置服务器监听地址和端口
- 默认端口为12345，支持自定义IP和端口
- 端口配置修改后需要重启程序生效
- 添加端口验证和重启提醒功能
- 支持简化输入格式（仅端口号自动转换为0.0.0.0:端口）
- **修复时间处理统一性问题**
- 统一所有视频时间存储为北京时间格式，解决UTC和北京时间混用导致的比较混乱
- 修复视频数据存储时间转换逻辑，将API返回的UTC时间正确转换为北京时间存储
- 优化UP主投稿增量获取的时间比较逻辑，确保时间比较的一致性
- 优化增量获取日志文案
- 修复时间格式不一致导致的视频更新检测问题

## v2.7.7 (2025-09-12)
- **修复UP主投稿断点续传问题**
- 修复删除UP主投稿源后重新添加时仍使用旧断点信息的问题
- 新增断点信息自动清理机制，删除投稿源时同步清理相关断点
- 修复数据库锁定错误，优化断点清理时机
- 确保重新添加投稿源时从第一页开始扫描，避免遗漏视频
- **优化日志系统**
- 将断点保存相关日志从info级别调整为debug级别
- 减少生产环境中的日志噪声，提升日志可读性

## v2.7.6.107 (2025-09-10)
- **优化风控验证配置表单**
- 移除不必要的web端口设置，简化配置界面
- 调整样式和结构，提升用户界面体验
- 简化保存逻辑，优化配置更新流程
- 提升整体用户体验和操作便利性

## v2.7.6.106 (2025-09-09)
- **完善风控验证系统**
- 移除清除gaia_vtoken缓存的方法，优化风控验证错误处理逻辑
- 简化代码结构，提升可读性和维护性

## v2.7.6.105 (2025-09-09)
- **新增风控验证配置**
- 支持在配置中启用风控验证功能
- 支持设置验证模式（手动/跳过/自动）和超时时间
- 更新相关API和前端逻辑，提升系统稳定性

## v2.7.6.104 (2025-09-09)
- **重构验证码处理逻辑**
- 新增验证协调器以管理验证码请求和结果
- 优化风控验证流程，提升处理效率
- 更新相关API以支持新的验证码处理方式
- 提升系统稳定性和用户体验

## v2.7.6.103 (2025-09-09)
- **新增风控验证模块**
- 支持通过验证码绕过风控限制
- 优化相关请求逻辑，提升成功率
- 更新配置以支持风控功能
- 新增验证码页面和服务器，完善用户体验

## v2.7.6.102 (2025-09-09)
- **优化数据库连接和预热逻辑**
- 调整代码格式以提升可读性
- 新增调试日志以便于监控数据库预热状态
- 确保数据加载到内存映射的效率和准确性
- 提升数据库操作性能和稳定性

## v2.7.6.101 (2025-09-08)
- **增强调试功能**
- 在Client中新增调试日志，记录Cookie发送信息
- 包括字段数量、DedeUserID__ckMd5的存在性及完整内容
- 以提升调试效率和问题排查能力

## v2.7.6.100 (2025-09-08)
- **优化凭证管理**
- 新增buvid4和dedeuserid_ckmd5字段到Credential结构体
- 在相关请求中使用新字段，优化凭证管理逻辑
- 提升登录状态检测的准确性和稳定性

## v2.7.6.99 (2025-09-07)
- **优化日志系统**
- 调整日志级别，将UP主视频搜索功能中的日志记录从info级别更改为debug级别
- 以减少生产环境中的日志噪声，提升调试效率

## v2.7.6.98 (2025-09-07)
- **新增UP主投稿视频搜索功能**
- 支持关键词搜索UP主投稿视频
- 更新相关请求结构体和API调用
- 优化前端搜索体验，提升用户操作便利性

## v2.7.6.97 (2025-08-22)
- **重构数据库架构，采用内存映射I/O技术**
- 移除复杂的内存数据库同步机制，改为直接使用SQLite内存映射
- 启用SQLite WAL模式和内存映射，大幅提升数据库读写性能
- 新增数据库预热功能，启动时自动加载关键数据到内存
- 简化数据库连接逻辑，提升系统稳定性和性能
- **修复手机上传视频的页面名称显示问题**
- 修复单P视频页面名称显示为VID_格式、mmexport格式等异常名称的问题
- 单P视频现在统一使用视频标题作为页面名称，确保显示正确
- 不影响多P视频、番剧、合集等其他类型视频的页面名称
- **修复UP主名称显示问题**
- 修复批处理日志中UP主显示为数字ID而非友好名称的问题
- 扫描日志现在正确显示UP主中文名称，而非数字ID
- 提升日志可读性，便于用户识别正在处理的UP主
- **修复合集文件夹和文件名安全化问题**
- 修复合集统一模式下，文件夹名称包含斜杠等特殊字符导致创建意外子目录的问题
- 修复合集poster和fanart文件名包含斜杠导致创建嵌套文件夹的问题
- 现在合集的文件夹名称、poster和fanart文件名都会进行安全化处理

## v2.7.6.96 (2025-08-18)
- **修复全量/增量模式切换导致的数据损坏问题**
- 修复从增量模式切换到全量模式时重新下载已存在视频的问题
- 全量模式现在会自动检查并跳过已存在的视频，避免数据覆盖
- 修复全量模式切换导致的CID错误和页面名称错误
- 优化日志信息，清楚显示跳过的视频数量和新视频数量

## v2.7.6.95 (2025-08-16)
- **修复UP主增量获取功能问题**
- 修复UP主一天上传多个视频时，只下载第一个视频其他视频被跳过的问题
- 现在可以正确下载UP主当天上传的所有新视频
- **优化日志系统**
- 日志文件现在按天生成（格式：logs-all-2025-08-16.csv）
- 避免长时间运行程序产生的巨大日志文件
- 自动日志轮转，跨天时自动创建新文件

## v2.7.6.94 (2025-08-09)
- **优化移动端界面体验**
- 修复视频管理页在手机端排序和筛选功能显示不全的问题
- 改进响应式布局，确保所有控件在小屏幕设备上正常显示
- 优化按钮文字显示，在移动端自动简化以节省空间
- **改进导航逻辑**
- 修正视频详情页的面包屑导航，上级页面从主页改为视频管理页

## v2.7.6.93 (2025-08-09)
- **修复重命名功能问题**
- 修复单P/多P视频重命名时创建重复子目录的问题
- 修复UP主名称中特殊字符显示错误的问题（如等号、引号等现在能正确显示）
- 优化文件路径处理，确保重命名后的目录结构正确

## v2.7.6.92 (2025-08-08)
- **修复数据库中page表数据不一致问题**
- 自动检测并修复cid不匹配的page记录
- 自动检测并修复video_id错误的page记录
- 自动标记内容已变化的视频为已删除状态
- 自动设置对应源启用下载已删除视频 
- 修复完毕后需要手动禁用下载已删除视频

## v2.7.6.91 (2025-08-05)
- **优化NFO生成中的UP主信息显示**
- 修复GitHub Issue #42：NFO使用UP主昵称导致Jellyfin无法匹配头像的问题
- 现在使用UID作为演员name字段，UP主名称作为role字段
- 无效UID时回退使用昵称，确保兼容性
- 新增Jellyfin字幕显示问题的FAQ文档
- 文档优化：添加Jellyfin字幕渲染设置说明

## v2.7.6.9 (2025-08-04)
- **修复合集视频通知显示"未知"的问题**
- 为Collection枚举添加title和arc字段，包含视频标题和作者信息
- 更新通知系统，从arc字段中提取UP主名称
- 完善视频信息存储，确保合集视频也有完整的元数据

## v2.7.6.8 (2025-08-04)
- **修复合集中多P视频下载失败问题**
- 合集统一模式：为多P视频的每个分P添加P01、P02等标识，避免文件名冲突
- 合集分离模式：多P视频使用multi_page_name模板，确保每个分P有唯一文件名
- 完美解决GitHub Issue #35报告的问题

## v2.7.6.7 (2025-08-01)
- **优化收藏夹扫描体验**
- 智能识别B站API过滤普通视频内的的特殊内容（番剧、纪录片等）调用特殊下载 实现下载而不会400错误
- 改进错误提示，明确说明内容被过滤的原因
- 避免重复扫描被过滤的收藏夹

## v2.7.6.6 (2025-07-31)
- **修复视频源删除时的500错误问题**
- 重构所有视频源（合集、收藏夹、稍后再看、UP主投稿、番剧）的删除逻辑
- 将"删除视频记录"改为"清空源ID字段"，避免删除共享视频时的重复删除错误
- 新增孤立视频检测和清理机制，确保只删除真正无归属的视频
- 增强删除操作的安全边界检查，防止误删其他源的记录
- 修复内存数据库video_source表同步支持，使用season_id作为唯一键
- 优化删除文件逻辑，增加危险路径检测和具体文件夹删除
- **修复配置更新在内存模式下不即时写入主数据库的问题**
- ConfigManager的save_config和update_config_item方法现在会立即同步到主数据库

## v2.7.6.5 (2025-07-31)
- **充电视频检测系统上线**
- 基于API返回的upower字段进行精确充电视频检测
- 新增is_upower_exclusive、is_upower_play、is_upower_preview字段支持
- 移除复杂的87007/87008错误码检测逻辑，提升检测准确性
- 简化错误分类系统，移除过时的充电视频错误处理
- 优化内存数据库连接日志级别，减少繁琐输出
- 清理冗余代码，提升系统性能和可维护性

## v2.7.6.4.2 (2025-07-30)
- **修复内存数据库完整同步时误删主数据库记录的严重bug**
- 重写sync_table_changes_full方法，基于业务唯一键而非自增ID进行记录匹配
- 防止因内存数据库与主数据库ID不一致导致的数据丢失
- 各表使用其真实唯一约束进行删除判断：
  - collection表: s_id + m_id + type
  - page表: video_id + pid
  - favorite表: f_id
  - submission表: upper_id
  - config_items表: key_name
  - video表: 6字段组合唯一约束

## v2.7.6.4.1 (2025-07-30)
- **完全修复内存数据库同步时的UNIQUE约束冲突问题**
- 基于数据库真实约束定义重新设计所有表的唯一性检查方法：
  - video表: 实现复杂的6字段组合约束检查（collection_id+favorite_id+watch_later_id+submission_id+source_id+bvid，含NULL值处理）
  - collection表: 使用s_id+m_id+type组合约束检查
  - page表: 使用video_id+pid组合约束检查
  - favorite表: 使用f_id单字段约束检查
  - submission表: 使用upper_id单字段约束检查
  - config_items表: 使用key_name主键约束检查
- 优化内存数据库与主数据库的ID映射处理逻辑
- 增强所有表同步过程的详细调试日志，便于问题追踪

## v2.7.6.4 (2025-07-29)
- 修复扫描间隔配置在内存模式下无法即时生效的问题
- 修复ConfigManager所有方法的内存模式兼容性
- 修复5个adapter模块函数的内存优化支持
- 修复utils/model.rs中create_videos的批量操作兼容性
- 移除config_changes表的999条记录限制
- 优化日志级别，将技术细节日志从info降级到debug
- 减少日志输出冗余，提升用户体验
- 修复仪表盘下次运行时间固定显示2小时的问题

## v2.7.6.3 (2025-07-29)
- 修复内存模式任务队列状态同步问题
- 修复任务重复执行导致的"合集已存在"错误
- 修复14个数据库操作函数的内存模式兼容性
- 新增任务队列处理完成后的自动同步机制
- 优化任务队列、模型更新、Adapter保存等核心功能
- 修复番剧杜比音频质量ID（30255）识别问题

## v2.7.6.2 (2025-07-28)
- 修复番剧源数据持久化问题
- 修复内存数据库长时运行稳定性问题
- 修复"no such table: collection"错误
- 新增内存数据库守护连接机制
- 新增内存数据库自动重建功能
- 新增周期性连接健康检查
- 优化数据库连接池配置
- 优化内存数据库同步日志级别
- 解决内存数据库重复下载问题
- 修复视频源处理顺序
- 修复推送通知时间显示问题
- 修复"no such table: video_source"错误

## v2.7.6.1 (2025-07-27)
- 统一时间格式处理
- 优化日志系统性能
- 简化时区配置
- 修复黑暗模式输入框对比度
- 修复稍后再看视频源添加问题

## v2.7.6 (2025-07-26)
- 重构Server酱推送通知系统
- 新增文件日志系统
- 修复充电视频误判问题
- 优化试看视频处理

## 2025-07-24
- 新增扫描源顺序优化
- 新增风控断点续传
- 新增错误视频筛选功能
- 优化黑暗模式适配

## 2025-07-23
- 修复番剧缓存未生效问题
- 番剧扫描速度提升60倍

## 2025-07-22  
- 新增番剧缓存机制（24小时）

## 2025-07-21
- 修复QR登录重复生成问题
- 优化登录流程

## 2025-07-20
- 优化视频元数据获取
- 修复封面图片路径问题

## 2025-07-19
- 改进错误处理机制
- 优化任务队列性能

## 更早版本
详见 [GitHub Releases](https://github.com/qq1582185982/bili-sync-01/releases)