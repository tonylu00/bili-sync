# ğŸ”§ ä»»åŠ¡é‡ç½®åŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**ä»»åŠ¡å®Œæˆåæ— æ³•é‡ç½®ä»»åŠ¡**

é”™è¯¯æç¤ºï¼š`é‡ç½®æ— æ•ˆ æ‰€æœ‰ä»»åŠ¡å‡æˆåŠŸï¼Œæ— éœ€é‡ç½®`

### ğŸ“Š é—®é¢˜åˆ†æ

åŸæœ‰çš„é‡ç½®é€»è¾‘åªèƒ½é‡ç½®"å¤±è´¥ä¸”è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"çš„ä»»åŠ¡ï¼ˆçŠ¶æ€å€¼ 4-6ï¼‰ï¼Œè€Œä¸èƒ½é‡ç½®å·²ç»æˆåŠŸçš„ä»»åŠ¡ï¼ˆçŠ¶æ€å€¼ 7ï¼‰ã€‚

**çŠ¶æ€å€¼å«ä¹‰ï¼š**
- 0-3ï¼šå¤±è´¥æ¬¡æ•°ï¼Œè¿˜å¯ä»¥é‡è¯•
- 4ï¼šè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆSTATUS_MAX_RETRY = 0b100ï¼‰
- 7ï¼šä»»åŠ¡æˆåŠŸï¼ˆSTATUS_OK = 0b111ï¼‰

å½“æ‰€æœ‰ä»»åŠ¡éƒ½æˆåŠŸæ—¶ï¼Œ`reset_failed()` ä¼šè¿”å› falseï¼Œå¯¼è‡´æ— æ³•é‡ç½®ã€‚

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. åç«¯æ”¹è¿›

#### æ–°å¢ `reset_all()` æ–¹æ³•
```rust
// crates/bili_sync/src/utils/status.rs
pub fn reset_all(&mut self) -> bool {
    let mut changed = false;
    for i in 0..N {
        let status = self.get_status(i);
        if status != 0 {
            self.set_status(i, 0);
            changed = true;
        }
    }
    if changed {
        self.set_completed(false);
    }
    changed
}
```

#### API æ”¯æŒå¼ºåˆ¶é‡ç½®
```rust
// crates/bili_sync/src/api/handler.rs
pub async fn reset_video(
    Path(id): Path<i32>,
    Query(params): Query<std::collections::HashMap<String, String>>,
    Extension(db): Extension<Arc<DatabaseConnection>>,
) -> Result<ApiResponse<ResetVideoResponse>, ApiError> {
    // æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶é‡ç½®
    let force_reset = params.get("force")
        .and_then(|v| v.parse::<bool>().ok())
        .unwrap_or(false);
    
    // æ ¹æ® force_reset å†³å®šä½¿ç”¨å“ªä¸ªé‡ç½®æ–¹æ³•
    if force_reset {
        page_status.reset_all()
    } else {
        page_status.reset_failed()
    }
}
```

### 2. å‰ç«¯æ”¹è¿›

#### API è°ƒç”¨æ”¯æŒå¼ºåˆ¶å‚æ•°
```typescript
// web/src/lib/api.ts
export async function resetVideo(id: number, force: boolean = false): Promise<ResetVideoResponse> {
    const url = force ? `${BASE_URL}/videos/${id}/reset?force=true` : `${BASE_URL}/videos/${id}/reset`;
    return fetchWithAuth(url, { method: 'POST' });
}
```

#### UI æä¾›ä¸¤ç§é‡ç½®é€‰é¡¹
```svelte
<!-- web/src/lib/components/VideoItem.svelte -->
<Button onclick={() => resetVideoItem(false)} variant="secondary">
    é‡ç½®å¤±è´¥
</Button>
<Button onclick={() => resetVideoItem(true)} variant="destructive">
    å¼ºåˆ¶é‡ç½®
</Button>
```

## ğŸ‰ ä½¿ç”¨æ•ˆæœ

### âœ… ä¸¤ç§é‡ç½®æ¨¡å¼

1. **é‡ç½®å¤±è´¥**ï¼ˆæ™®é€šé‡ç½®ï¼‰
   - åªé‡ç½®å¤±è´¥è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°çš„ä»»åŠ¡
   - é€‚ç”¨äºåªæƒ³é‡è¯•å¤±è´¥ä»»åŠ¡çš„åœºæ™¯

2. **å¼ºåˆ¶é‡ç½®**
   - é‡ç½®æ‰€æœ‰ä»»åŠ¡ï¼ŒåŒ…æ‹¬æˆåŠŸçš„ä»»åŠ¡
   - é€‚ç”¨äºæƒ³é‡æ–°ä¸‹è½½æ‰€æœ‰å†…å®¹çš„åœºæ™¯

### ğŸ“‹ æç¤ºä¿¡æ¯ä¼˜åŒ–

| åœºæ™¯ | æç¤ºä¿¡æ¯ |
|------|----------|
| æ™®é€šé‡ç½®æˆåŠŸ | "é‡ç½®æˆåŠŸï¼Œå·²é‡ç½®è§†é¢‘ä¸è§†é¢‘çš„ X æ¡ page." |
| å¼ºåˆ¶é‡ç½®æˆåŠŸ | "é‡ç½®æˆåŠŸï¼Œå·²é‡ç½®è§†é¢‘ä¸è§†é¢‘çš„ X æ¡ page. (å¼ºåˆ¶é‡ç½®)" |
| æ™®é€šé‡ç½®æ— æ•ˆ | "é‡ç½®æ— æ•ˆï¼Œæ‰€æœ‰ä»»åŠ¡å‡æˆåŠŸï¼Œæ— éœ€é‡ç½®ã€‚å¦‚éœ€é‡æ–°ä¸‹è½½ï¼Œè¯·ä½¿ç”¨å¼ºåˆ¶é‡ç½®ã€‚" |
| å¼ºåˆ¶é‡ç½®æ— ä»»åŠ¡ | "æ— ä»»åŠ¡å¯é‡ç½®ï¼Œè¯¥è§†é¢‘æš‚æ— ä»»ä½•ä»»åŠ¡" |

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### ğŸ”§ çŠ¶æ€ç®¡ç†

**Status ç»“æ„ä½“çš„çŠ¶æ€ç®¡ç†ï¼š**
- ä½¿ç”¨ u32 å­˜å‚¨æ‰€æœ‰å­ä»»åŠ¡çŠ¶æ€
- æ¯ 3 ä½è¡¨ç¤ºä¸€ä¸ªå­ä»»åŠ¡çŠ¶æ€ï¼ˆæœ€å¤šæ”¯æŒ 10 ä¸ªå­ä»»åŠ¡ï¼‰
- æœ€é«˜ä½ï¼ˆç¬¬ 31 ä½ï¼‰è¡¨ç¤ºæ•´ä½“å®Œæˆæ ‡è®°

**VideoStatus åŒ…å« 5 ä¸ªå­ä»»åŠ¡ï¼š**
1. è§†é¢‘å°é¢
2. è§†é¢‘ä¿¡æ¯
3. Upä¸»å¤´åƒ
4. Upä¸»ä¿¡æ¯
5. åˆ†Pä¸‹è½½

**PageStatus åŒ…å« 5 ä¸ªå­ä»»åŠ¡ï¼š**
1. è§†é¢‘å°é¢
2. è§†é¢‘å†…å®¹
3. è§†é¢‘ä¿¡æ¯
4. è§†é¢‘å¼¹å¹•
5. è§†é¢‘å­—å¹•

### ğŸ›¡ï¸ å®‰å…¨æ€§

- å¼ºåˆ¶é‡ç½®éœ€è¦ç”¨æˆ·æ˜ç¡®é€‰æ‹©
- ä½¿ç”¨ä¸åŒçš„æŒ‰é’®æ ·å¼åŒºåˆ†æ“ä½œå±é™©ç¨‹åº¦
- æ‰€æœ‰æ“ä½œéƒ½æœ‰æ˜ç¡®çš„æç¤ºä¿¡æ¯

## ğŸš€ æ›´æ–°è¯´æ˜

**ç‰ˆæœ¬ï¼š** ä¿®å¤äº 2025-12-11

**å½±å“èŒƒå›´ï¼š**
- åç«¯ API å…¼å®¹æ€§ï¼šå®Œå…¨å…¼å®¹ï¼Œæ–°å¢å¯é€‰å‚æ•°
- å‰ç«¯ç•Œé¢ï¼šæ–°å¢å¼ºåˆ¶é‡ç½®æŒ‰é’®
- æ•°æ®åº“ï¼šæ— éœ€è¿ç§»

**ä½¿ç”¨æ–¹æ³•ï¼š**
1. æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
2. åœ¨è§†é¢‘åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªè§†é¢‘ç°åœ¨æœ‰ä¸¤ä¸ªé‡ç½®æŒ‰é’®
3. "é‡ç½®å¤±è´¥"æŒ‰é’®æ‰§è¡Œæ™®é€šé‡ç½®
4. "å¼ºåˆ¶é‡ç½®"æŒ‰é’®é‡ç½®æ‰€æœ‰ä»»åŠ¡ 